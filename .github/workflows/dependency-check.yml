name: Dependency Vulnerability Check

on:
  pull_request:
    paths:
      - 'package.json'
      - 'pnpm-lock.yaml'
  push:
    branches:
      - main
      - develop
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  dependency-audit:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run pnpm audit
        id: audit
        run: pnpm audit --json > audit-report.json || true
        continue-on-error: true
      
      - name: Parse audit results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('audit-report.json', 'utf8'));
            const vulnerabilities = report.vulnerabilities || {};
            const criticalCount = Object.values(vulnerabilities).filter(v => v.severity === 'critical').length;
            const highCount = Object.values(vulnerabilities).filter(v => v.severity === 'high').length;
            
            console.log(`Critical: ${criticalCount}, High: ${highCount}`);
            
            if (criticalCount > 0) {
              core.setFailed(`Found ${criticalCount} critical vulnerabilities`);
            }
        continue-on-error: true
      
      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit-${{ github.sha }}
          path: audit-report.json
          retention-days: 30
  
  snyk-scan:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Snyk Security Scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
        continue-on-error: true
  
  license-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Check licenses
        run: pnpm licenses list
        continue-on-error: true
